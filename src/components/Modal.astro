---
import { TECHNIQUE_LABELS, TECHNIQUE_ICONS, COMMUNITY_ICON, isCommunityNade, type Nade } from '../lib/nades';

interface Props {
  nades: Nade[];
}

const { nades } = Astro.props;

function techClass(t: string): string {
  if (['left', 'right'].includes(t)) return 'tech-simple';
  if (['left_jump', 'right_jump'].includes(t)) return 'tech-jump';
  if (['run_left', 'run_right'].includes(t)) return 'tech-run';
  return 'tech-complex';
}

const modalData = nades.map(n => ({
  title: `${n.titleTo} from ${n.titleFrom}`,
  map: n.map,
  side: n.team === 't' ? 'T' : 'CT',
  technique: TECHNIQUE_LABELS[n.technique] || n.technique,
  techClass: techClass(n.technique),
  techIcon: TECHNIQUE_ICONS[n.technique] || '',
  isCommunity: isCommunityNade(n),
  movement: n.movement,
  console: n.console,
  source: n.source_url,
  position: `data/${n.map}/${n.slug}/position.jpg`,
  aim: `data/${n.map}/${n.slug}/aim.jpg`,
  result: `data/${n.map}/${n.slug}/result.jpg`,
  resultVideo: `data/${n.map}/${n.slug}/result.mp4`,
  capPos: n.captions[0] || 'Position',
  capAim: n.captions[1] || 'Aim',
  slug: n.slug,
}));

const communityIconSvg = COMMUNITY_ICON;
---

<div class="modal-bg" id="modal-bg">
  <div class="modal" id="modal">
    <button class="modal-close" id="modal-close">&times;</button>
    <div class="modal-head">
      <h2 id="m-title"></h2>
      <span class="technique-pill" id="m-technique"></span>
      <div class="modal-tags" id="m-tags"></div>
    </div>
    <div class="modal-frames">
      <div class="modal-frame">
        <img id="m-pos" alt="Position" />
        <p id="m-cap-pos"></p>
        <div class="report-btns" data-frame="position">
          <button class="report-btn" data-dir="earlier" title="Frame should be earlier">&#8592;</button>
          <button class="report-btn" data-dir="later" title="Frame should be later">&#8594;</button>
        </div>
      </div>
      <div class="modal-frame">
        <img id="m-aim" alt="Aim" />
        <p id="m-cap-aim"></p>
        <div class="report-btns" data-frame="aim">
          <button class="report-btn" data-dir="earlier" title="Frame should be earlier">&#8592;</button>
          <button class="report-btn" data-dir="later" title="Frame should be later">&#8594;</button>
        </div>
      </div>
      <div class="modal-frame">
        <video id="m-res-video" muted loop playsinline style="display:none"></video>
        <img id="m-res" alt="Result" />
        <p>Result</p>
        <div class="report-btns" data-frame="result">
          <button class="report-btn" data-dir="earlier" title="Frame should be earlier">&#8592;</button>
          <button class="report-btn" data-dir="later" title="Frame should be later">&#8594;</button>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <code class="console-cmd" id="m-console" title="Click to copy"></code>
      <a class="source-link" id="m-source" target="_blank" rel="noopener">csnades.gg &#8599;</a>
      <button class="lineup-report-btn" id="lineup-report-btn" title="Report this lineup">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg>
      </button>
      <div class="lineup-report-dropdown" id="lineup-report-dropdown" style="display:none">
        <button data-reason="outdated">Outdated</button>
        <button data-reason="doesnt_work">Doesn't work</button>
        <button data-reason="wrong_map">Wrong map</button>
        <button data-reason="other">Other</button>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ modalData, communityIconSvg }}>
  window.__modalData = modalData;
  window.__communityIconSvg = communityIconSvg;
</script>

<script>
  const base = (window as any).__base || '/';
  const data = (window as any).__modalData as Array<{
    title: string;
    map: string;
    side: string;
    technique: string;
    techClass: string;
    techIcon: string;
    isCommunity: boolean;
    movement: string;
    console: string;
    source: string;
    position: string;
    aim: string;
    result: string;
    resultVideo: string;
    capPos: string;
    capAim: string;
    slug: string;
  }>;
  const communityIcon = (window as any).__communityIconSvg as string;

  const bg = document.getElementById('modal-bg')!;
  const modal = document.getElementById('modal')!;
  const closeBtn = document.getElementById('modal-close')!;
  const mTitle = document.getElementById('m-title')!;
  const mTechnique = document.getElementById('m-technique')!;
  const mTags = document.getElementById('m-tags')!;
  const mPos = document.getElementById('m-pos') as HTMLImageElement;
  const mAim = document.getElementById('m-aim') as HTMLImageElement;
  const mRes = document.getElementById('m-res') as HTMLImageElement;
  const mResVideo = document.getElementById('m-res-video') as HTMLVideoElement;
  const mCapPos = document.getElementById('m-cap-pos')!;
  const mCapAim = document.getElementById('m-cap-aim')!;
  const mConsole = document.getElementById('m-console')!;
  const mSource = document.getElementById('m-source') as HTMLAnchorElement;

  let currentModalSlug = '';

  function openModal(idx: number) {
    const d = data[idx];
    if (!d) return;

    currentModalSlug = d.slug;

    // Reset report button states from previous modal
    document.querySelectorAll('.report-btn.reported').forEach(btn => {
      btn.classList.remove('reported');
    });

    // Reset lineup report state
    const lrBtn = document.getElementById('lineup-report-btn')!;
    const lrDropdown = document.getElementById('lineup-report-dropdown')!;
    lrBtn.classList.remove('reported');
    lrDropdown.style.display = 'none';

    mTitle.textContent = d.title;

    // Build technique pill with icon + text (avoid innerHTML for scraped text)
    mTechnique.innerHTML = '';
    if (d.techIcon) {
      const iconSpan = document.createElement('span');
      iconSpan.className = 'tech-icon tech-icon-md';
      iconSpan.innerHTML = d.techIcon; // safe: compile-time SVG constant from nades.ts
      mTechnique.appendChild(iconSpan);
    }
    const techLabel = document.createElement('span');
    techLabel.textContent = d.technique; // safe: uses textContent, not innerHTML
    mTechnique.appendChild(techLabel);
    mTechnique.className = `technique-pill ${d.techClass}`;
    mTechnique.title = d.technique;

    mTags.innerHTML = '';
    const mapTag = document.createElement('span');
    mapTag.className = `tag map-${d.map}`;
    mapTag.textContent = d.map;
    mTags.appendChild(mapTag);

    const sideTag = document.createElement('span');
    sideTag.className = `tag side-${d.side === 'T' ? 't' : 'ct'}`;
    sideTag.textContent = d.side;
    mTags.appendChild(sideTag);

    if (d.movement && d.movement !== 'stationary') {
      const moveTag = document.createElement('span');
      moveTag.className = 'tag';
      moveTag.textContent = d.movement;
      mTags.appendChild(moveTag);
    }

    if (d.isCommunity) {
      const communityTag = document.createElement('span');
      communityTag.className = 'tag community-badge';
      communityTag.title = 'Community submitted';
      const cIconSpan = document.createElement('span');
      cIconSpan.innerHTML = communityIcon; // safe: compile-time SVG constant
      communityTag.appendChild(cIconSpan);
      communityTag.appendChild(document.createTextNode(' Community'));
      mTags.appendChild(communityTag);
    }

    mPos.src = d.position;
    mAim.src = d.aim;
    mCapPos.textContent = d.capPos;
    mCapAim.textContent = d.capAim;

    // Result: show still image by default, store video src for hover/touch
    mResVideo.style.display = 'none';
    mResVideo.removeAttribute('src');
    mRes.style.display = '';
    mRes.src = d.result;
    // Store video URL for lazy loading on hover/touch
    const resFrame = mResVideo.closest('.modal-frame') as HTMLElement;
    resFrame.dataset.videoSrc = d.resultVideo;
    resFrame.dataset.hasVideo = 'unknown'; // will be determined on first hover/touch

    mConsole.textContent = d.console;
    mSource.href = d.source;

    bg.classList.add('open');
    document.body.style.overflow = 'hidden';

    // Push history state so back button closes modal
    history.pushState({ modal: true, slug: d.slug }, '');
  }

  let closingFromPopstate = false;

  function closeModal() {
    // Guard: already closed
    if (!bg.classList.contains('open')) return;

    bg.classList.remove('open');
    document.body.style.overflow = '';

    // Stop video and clean up
    mResVideo.onerror = null;
    mResVideo.pause();
    mResVideo.removeAttribute('src');
    mResVideo.load();
    mResVideo.style.display = 'none';
    mRes.style.display = '';

    // Navigate back unless this close was triggered by popstate
    if (!closingFromPopstate) {
      history.back();
    }
    closingFromPopstate = false;
  }

  // Close on background click (not modal content)
  bg.addEventListener('click', (e) => {
    if (e.target === bg) closeModal();
  });

  // Close button
  closeBtn.addEventListener('click', closeModal);

  // Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
  });

  // Back button closes modal instead of navigating away
  window.addEventListener('popstate', () => {
    if (bg.classList.contains('open')) {
      closingFromPopstate = true;
      closeModal();
    }
  });

  // --- Hold-to-play video on result frame ---
  const resultFrame = mResVideo.closest('.modal-frame') as HTMLElement;

  function startVideoPlayback() {
    const videoSrc = resultFrame.dataset.videoSrc;
    if (!videoSrc || resultFrame.dataset.hasVideo === 'no') return;

    mResVideo.onerror = () => {
      // Video doesn't exist, mark so we don't try again
      resultFrame.dataset.hasVideo = 'no';
      mResVideo.style.display = 'none';
      mRes.style.display = '';
    };

    if (!mResVideo.src || mResVideo.src !== new URL(videoSrc, window.location.href).href) {
      mResVideo.src = videoSrc;
    }

    mResVideo.style.display = '';
    mRes.style.display = 'none';
    mResVideo.currentTime = 0;
    mResVideo.play().catch(() => {
      // Play failed (no video or browser restriction)
      resultFrame.dataset.hasVideo = 'no';
      mResVideo.style.display = 'none';
      mRes.style.display = '';
    });
  }

  function stopVideoPlayback() {
    mResVideo.pause();
    mResVideo.style.display = 'none';
    mRes.style.display = '';
  }

  // Desktop: hover-to-play (only on devices with hover capability)
  const hoverQuery = window.matchMedia('(hover: hover)');
  if (hoverQuery.matches) {
    resultFrame.addEventListener('mouseenter', () => {
      if (!bg.classList.contains('open')) return;
      startVideoPlayback();
    });
    resultFrame.addEventListener('mouseleave', () => {
      if (!bg.classList.contains('open')) return;
      stopVideoPlayback();
    });
  }

  // Mobile: touch-and-hold to play
  resultFrame.addEventListener('touchstart', (e) => {
    if (!bg.classList.contains('open')) return;
    e.preventDefault(); // prevent ghost click / scroll
    startVideoPlayback();
  }, { passive: false });

  resultFrame.addEventListener('touchend', (e) => {
    if (!bg.classList.contains('open')) return;
    e.preventDefault();
    stopVideoPlayback();
  }, { passive: false });

  resultFrame.addEventListener('touchcancel', () => {
    if (!bg.classList.contains('open')) return;
    stopVideoPlayback();
  });

  // Copy console command
  mConsole.addEventListener('click', () => {
    const text = mConsole.textContent || '';
    navigator.clipboard.writeText(text).then(() => {
      const original = mConsole.textContent;
      mConsole.textContent = 'Copied!';
      setTimeout(() => { mConsole.textContent = original; }, 1200);
    });
  });

  // Frame images click to open full size
  [mPos, mAim, mRes].forEach(img => {
    img.addEventListener('click', () => {
      window.open(img.src, '_blank');
    });
  });

  // Video click to open full size
  mResVideo.addEventListener('click', () => {
    window.open(mResVideo.src, '_blank');
  });

  // Card click handlers
  document.querySelectorAll('.nade-card').forEach(card => {
    card.addEventListener('click', () => {
      const idx = parseInt((card as HTMLElement).dataset.idx!, 10);
      openModal(idx);
    });
  });

  // Report button handlers
  document.querySelectorAll('.report-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const el = btn as HTMLElement;
      const container = el.closest('.report-btns') as HTMLElement;
      const frameType = container.dataset.frame!;
      const direction = el.dataset.dir!;

      const res = await fetch(`${base}api/reports`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slug: currentModalSlug, frameType, direction }),
      });

      if (res.ok) {
        // Deselect sibling (mutually exclusive: earlier OR later, not both)
        container.querySelectorAll('.report-btn').forEach(sibling => {
          sibling.classList.remove('reported');
        });
        el.classList.add('reported');
      }
    });
  });

  // Lineup report (flag for deletion) handlers
  const lineupReportBtn = document.getElementById('lineup-report-btn')!;
  const lineupReportDropdown = document.getElementById('lineup-report-dropdown')!;

  lineupReportBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    if (lineupReportBtn.classList.contains('reported')) return;
    const isVisible = lineupReportDropdown.style.display === 'flex';
    lineupReportDropdown.style.display = isVisible ? 'none' : 'flex';
  });

  lineupReportDropdown.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const reason = (btn as HTMLElement).dataset.reason!;

      const res = await fetch(`${base}api/lineup-reports`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slug: currentModalSlug, reason }),
      });

      if (res.ok) {
        lineupReportDropdown.style.display = 'none';
        lineupReportBtn.classList.add('reported');
      }
    });
  });

  // Close dropdown when clicking elsewhere in the modal
  modal.addEventListener('click', () => {
    lineupReportDropdown.style.display = 'none';
  });
</script>
