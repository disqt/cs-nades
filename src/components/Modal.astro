---
import { decomposeTechnique, movementComponent, ICON_FLAG, ICON_COMMUNITY, isCommunityNade, type Nade, type TechComponent } from '../lib/nades';

interface Props {
  nades: Nade[];
}

const { nades } = Astro.props;

const modalData = nades.map(n => ({
  title: `${n.titleTo} from ${n.titleFrom}`,
  map: n.map,
  side: n.team === 't' ? 'T' : 'CT',
  techComponents: [...decomposeTechnique(n.technique), ...(movementComponent(n.movement) ? [movementComponent(n.movement)] : [])] as TechComponent[],
  isCommunity: isCommunityNade(n),
  movement: n.movement,
  console: n.console,
  source: n.source_url,
  position: `data/${n.map}/${n.slug}/position.jpg`,
  aim: `data/${n.map}/${n.slug}/aim.jpg`,
  result: `data/${n.map}/${n.slug}/result.jpg`,
  resultVideo: `data/${n.map}/${n.slug}/result.mp4`,
  capPos: n.captions[0] || 'Position',
  capAim: n.captions[1] || 'Aim',
  slug: n.slug,
}));

const flagIconSvg = ICON_FLAG;
const communityIconSvg = ICON_COMMUNITY;
---

<div class="modal-bg" id="modal-bg">
  <div class="modal" id="modal">
    <button class="modal-close" id="modal-close">&times;</button>
    <div class="modal-head">
      <h2 id="m-title"></h2>
      <div class="technique-badges" id="m-technique"></div>
      <div class="modal-tags" id="m-tags"></div>
    </div>
    <div class="modal-frames">
      <div class="modal-frame">
        <img id="m-pos" alt="Position" />
        <p id="m-cap-pos"></p>
        <div class="report-btns" data-frame="position">
          <button class="report-btn" data-dir="earlier" title="Frame should be earlier">&#8592;</button>
          <button class="report-btn" data-dir="later" title="Frame should be later">&#8594;</button>
        </div>
      </div>
      <div class="modal-frame">
        <img id="m-aim" alt="Aim" />
        <p id="m-cap-aim"></p>
        <div class="report-btns" data-frame="aim">
          <button class="report-btn" data-dir="earlier" title="Frame should be earlier">&#8592;</button>
          <button class="report-btn" data-dir="later" title="Frame should be later">&#8594;</button>
        </div>
      </div>
      <div class="modal-frame">
        <video id="m-res-video" muted loop playsinline style="display:none"></video>
        <img id="m-res" alt="Result" />
        <p>Result</p>
        <div class="report-btns" data-frame="result">
          <button class="report-btn" data-dir="earlier" title="Frame should be earlier">&#8592;</button>
          <button class="report-btn" data-dir="later" title="Frame should be later">&#8594;</button>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="setpos-btn" id="m-setpos" title="Click to copy setpos command">
        <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M19.4 20H9.6C9.26863 20 9 19.7314 9 19.4V9.6C9 9.26863 9.26863 9 9.6 9H19.4C19.7314 9 20 9.26863 20 9.6V19.4C20 19.7314 19.7314 20 19.4 20Z" stroke-linecap="round" stroke-linejoin="round"/><path d="M15 9V4.6C15 4.26863 14.7314 4 14.4 4H4.6C4.26863 4 4 4.26863 4 4.6V14.4C4 14.7314 4.26863 15 4.6 15H9" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Copy setpos
      </button>
      <a class="source-link" id="m-source" target="_blank" rel="noopener">csnades.gg &#8599;</a>
      <button class="report-lineup-btn" id="lineup-report-btn" title="Report this lineup">
        <span class="tech-icon" id="report-icon"></span>
        Report
      </button>
      <div class="lineup-report-dropdown" id="lineup-report-dropdown" style="display:none">
        <button data-reason="outdated">Outdated</button>
        <button data-reason="doesnt_work">Doesn't work</button>
        <button data-reason="wrong_map">Wrong map</button>
        <button data-reason="other">Other</button>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ modalData, flagIconSvg, communityIconSvg }}>
  window.__modalData = modalData;
  window.__flagIconSvg = flagIconSvg;
  window.__communityIconSvg = communityIconSvg;
</script>

<script>
  const base = (window as any).__base || '/';
  const data = (window as any).__modalData as Array<{
    title: string;
    map: string;
    side: string;
    techComponents: Array<{icon: string; label: string}>;
    isCommunity: boolean;
    movement: string;
    console: string;
    source: string;
    position: string;
    aim: string;
    result: string;
    resultVideo: string;
    capPos: string;
    capAim: string;
    slug: string;
  }>;
  const communityIcon = (window as any).__communityIconSvg as string;

  const bg = document.getElementById('modal-bg')!;
  const modal = document.getElementById('modal')!;
  const closeBtn = document.getElementById('modal-close')!;
  const mTitle = document.getElementById('m-title')!;
  const mTechnique = document.getElementById('m-technique')!;
  const mTags = document.getElementById('m-tags')!;
  const mPos = document.getElementById('m-pos') as HTMLImageElement;
  const mAim = document.getElementById('m-aim') as HTMLImageElement;
  const mRes = document.getElementById('m-res') as HTMLImageElement;
  const mResVideo = document.getElementById('m-res-video') as HTMLVideoElement;
  const mCapPos = document.getElementById('m-cap-pos')!;
  const mCapAim = document.getElementById('m-cap-aim')!;
  const mSetpos = document.getElementById('m-setpos')!;
  const reportIcon = document.getElementById('report-icon')!;
  const mSource = document.getElementById('m-source') as HTMLAnchorElement;

  reportIcon.innerHTML = (window as any).__flagIconSvg; // safe: compile-time constant

  let currentModalSlug = '';

  function openModal(idx: number) {
    const d = data[idx];
    if (!d) return;

    currentModalSlug = d.slug;

    // Reset report button states from previous modal
    document.querySelectorAll('.report-btn.reported').forEach(btn => {
      btn.classList.remove('reported');
    });

    // Reset lineup report state
    const lrBtn = document.getElementById('lineup-report-btn')!;
    const lrDropdown = document.getElementById('lineup-report-dropdown')!;
    lrBtn.classList.remove('reported');
    lrDropdown.style.display = 'none';

    mTitle.textContent = d.title;

    // Build technique badges (decomposed components)
    mTechnique.innerHTML = '';
    for (const comp of d.techComponents) {
      const badge = document.createElement('span');
      badge.className = 'technique-badge';
      const iconSpan = document.createElement('span');
      iconSpan.className = 'tech-icon tech-icon-lg';
      iconSpan.innerHTML = comp.icon; // safe: compile-time SVG constant
      badge.appendChild(iconSpan);
      const label = document.createElement('span');
      label.textContent = comp.label;
      badge.appendChild(label);
      mTechnique.appendChild(badge);
    }

    mTags.innerHTML = '';
    const mapTag = document.createElement('span');
    mapTag.className = `tag map-${d.map}`;
    mapTag.textContent = d.map;
    mTags.appendChild(mapTag);

    const sideTag = document.createElement('span');
    sideTag.className = `tag side-${d.side === 'T' ? 't' : 'ct'}`;
    sideTag.textContent = d.side;
    mTags.appendChild(sideTag);

    if (d.isCommunity) {
      const communityTag = document.createElement('span');
      communityTag.className = 'tag community-badge';
      communityTag.title = 'Community submitted';
      const cIconSpan = document.createElement('span');
      cIconSpan.innerHTML = communityIcon; // safe: compile-time SVG constant
      communityTag.appendChild(cIconSpan);
      communityTag.appendChild(document.createTextNode(' Community'));
      mTags.appendChild(communityTag);
    }

    mPos.src = d.position;
    mAim.src = d.aim;
    mCapPos.textContent = d.capPos;
    mCapAim.textContent = d.capAim;

    // Result: show still image by default, store video src for hover/touch
    mResVideo.style.display = 'none';
    mResVideo.removeAttribute('src');
    mRes.style.display = '';
    mRes.src = d.result;
    // Store video URL for lazy loading on hover/touch
    const resFrame = mResVideo.closest('.modal-frame') as HTMLElement;
    resFrame.dataset.videoSrc = d.resultVideo;
    resFrame.dataset.hasVideo = 'unknown'; // will be determined on first hover/touch

    mSetpos.dataset.cmd = d.console;
    mSource.href = d.source;

    bg.classList.add('open');
    document.body.style.overflow = 'hidden';

    // Push history state so back button closes modal
    history.pushState({ modal: true, slug: d.slug }, '');
  }

  let closingFromPopstate = false;

  function closeModal() {
    // Guard: already closed
    if (!bg.classList.contains('open')) return;

    bg.classList.remove('open');
    document.body.style.overflow = '';

    // Stop video and clean up
    mResVideo.onerror = null;
    mResVideo.pause();
    mResVideo.removeAttribute('src');
    mResVideo.load();
    mResVideo.style.display = 'none';
    mRes.style.display = '';

    // Navigate back unless this close was triggered by popstate
    if (!closingFromPopstate) {
      history.back();
    }
    closingFromPopstate = false;
  }

  // Close on background click (not modal content)
  bg.addEventListener('click', (e) => {
    if (e.target === bg) closeModal();
  });

  // Close button
  closeBtn.addEventListener('click', closeModal);

  // Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
  });

  // Back button closes modal instead of navigating away
  window.addEventListener('popstate', () => {
    if (bg.classList.contains('open')) {
      closingFromPopstate = true;
      closeModal();
    }
  });

  // --- Hold-to-play video on result frame ---
  const resultFrame = mResVideo.closest('.modal-frame') as HTMLElement;

  function startVideoPlayback() {
    const videoSrc = resultFrame.dataset.videoSrc;
    if (!videoSrc || resultFrame.dataset.hasVideo === 'no') return;

    mResVideo.onerror = () => {
      // Video doesn't exist, mark so we don't try again
      resultFrame.dataset.hasVideo = 'no';
      mResVideo.style.display = 'none';
      mRes.style.display = '';
    };

    if (!mResVideo.src || mResVideo.src !== new URL(videoSrc, window.location.href).href) {
      mResVideo.src = videoSrc;
    }

    mResVideo.style.display = '';
    mRes.style.display = 'none';
    mResVideo.currentTime = 0;
    mResVideo.play().catch(() => {
      // Play failed (no video or browser restriction)
      resultFrame.dataset.hasVideo = 'no';
      mResVideo.style.display = 'none';
      mRes.style.display = '';
    });
  }

  function stopVideoPlayback() {
    mResVideo.pause();
    mResVideo.style.display = 'none';
    mRes.style.display = '';
  }

  // Desktop: hover-to-play (only on devices with hover capability)
  const hoverQuery = window.matchMedia('(hover: hover)');
  if (hoverQuery.matches) {
    resultFrame.addEventListener('mouseenter', () => {
      if (!bg.classList.contains('open')) return;
      startVideoPlayback();
    });
    resultFrame.addEventListener('mouseleave', () => {
      if (!bg.classList.contains('open')) return;
      stopVideoPlayback();
    });
  }

  // Mobile: touch-and-hold to play
  resultFrame.addEventListener('touchstart', (e) => {
    if (!bg.classList.contains('open')) return;
    e.preventDefault(); // prevent ghost click / scroll
    startVideoPlayback();
  }, { passive: false });

  resultFrame.addEventListener('touchend', (e) => {
    if (!bg.classList.contains('open')) return;
    e.preventDefault();
    stopVideoPlayback();
  }, { passive: false });

  resultFrame.addEventListener('touchcancel', () => {
    if (!bg.classList.contains('open')) return;
    stopVideoPlayback();
  });

  // Collapsed setpos: copy on click
  const setposOriginalHTML = mSetpos.innerHTML;
  mSetpos.addEventListener('click', () => {
    const text = mSetpos.dataset.cmd || '';
    navigator.clipboard.writeText(text).then(() => {
      mSetpos.textContent = 'Copied!';
      setTimeout(() => { mSetpos.innerHTML = setposOriginalHTML; }, 1200);
    });
  });

  // Frame images click to open full size
  [mPos, mAim, mRes].forEach(img => {
    img.addEventListener('click', () => {
      window.open(img.src, '_blank');
    });
  });

  // Video click to open full size
  mResVideo.addEventListener('click', () => {
    window.open(mResVideo.src, '_blank');
  });

  // Card click handlers
  document.querySelectorAll('.nade-card').forEach(card => {
    card.addEventListener('click', () => {
      const idx = parseInt((card as HTMLElement).dataset.idx!, 10);
      openModal(idx);
    });
  });

  // Report button handlers
  document.querySelectorAll('.report-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const el = btn as HTMLElement;
      const container = el.closest('.report-btns') as HTMLElement;
      const frameType = container.dataset.frame!;
      const direction = el.dataset.dir!;

      const res = await fetch(`${base}api/reports`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slug: currentModalSlug, frameType, direction }),
      });

      if (res.ok) {
        // Deselect sibling (mutually exclusive: earlier OR later, not both)
        container.querySelectorAll('.report-btn').forEach(sibling => {
          sibling.classList.remove('reported');
        });
        el.classList.add('reported');
      }
    });
  });

  // Lineup report (flag for deletion) handlers
  const lineupReportBtn = document.getElementById('lineup-report-btn')!;
  const lineupReportDropdown = document.getElementById('lineup-report-dropdown')!;

  lineupReportBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    if (lineupReportBtn.classList.contains('reported')) return;
    const isVisible = lineupReportDropdown.style.display === 'flex';
    lineupReportDropdown.style.display = isVisible ? 'none' : 'flex';
  });

  lineupReportDropdown.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      const reason = (btn as HTMLElement).dataset.reason!;

      const res = await fetch(`${base}api/lineup-reports`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ slug: currentModalSlug, reason }),
      });

      if (res.ok) {
        lineupReportDropdown.style.display = 'none';
        lineupReportBtn.classList.add('reported');
      }
    });
  });

  // Close dropdown when clicking elsewhere in the modal
  modal.addEventListener('click', () => {
    lineupReportDropdown.style.display = 'none';
  });
</script>
