---
import Layout from '../components/Layout.astro';

const maps = ['mirage', 'dust2', 'inferno', 'overpass', 'ancient', 'anubis', 'nuke'];
---

<Layout title="Submit a Lineup">
  <a class="back-link" href={import.meta.env.BASE_URL}>&larr; Back to lineups</a>
  <h1>Submit a Lineup</h1>
  <p class="subtitle">Share a grenade lineup for the community</p>

  <div class="submit-form-container">
    <div class="submit-mode-toggle">
      <button class="mode-btn active" data-mode="url" id="mode-url-btn">csnades.gg URL</button>
      <button class="mode-btn" data-mode="screenshots" id="mode-ss-btn">Upload Screenshots</button>
    </div>

    <form id="submit-form" enctype="multipart/form-data">
      <div class="form-section" id="url-section">
        <label for="csnades_url">csnades.gg URL</label>
        <input type="url" name="csnades_url" id="csnades_url"
               placeholder="https://csnades.gg/mirage/smokes/example-slug"
               pattern="https://csnades\.gg/.*" />
      </div>

      <div class="form-section hidden" id="ss-section">
        <label for="map-select">Map</label>
        <select name="map" id="map-select">
          <option value="">Select a map...</option>
          {maps.map(m => <option value={m}>{m}</option>)}
        </select>

        <label for="side-select">Side</label>
        <select name="side" id="side-select">
          <option value="">Select a side...</option>
          <option value="t">T (Terrorist)</option>
          <option value="ct">CT (Counter-Terrorist)</option>
        </select>

        <label for="lineup-name">Lineup Name</label>
        <input type="text" name="lineup_name" id="lineup-name"
               placeholder="e.g. T Spawn to A Site" required />

        <label for="stand-desc">Stand Description</label>
        <input type="text" name="stand_desc" id="stand-desc"
               placeholder="e.g. Corner of T spawn box" required />

        <label for="aim-desc">Aim Description</label>
        <input type="text" name="aim_desc" id="aim-desc"
               placeholder="e.g. Align crosshair with antenna tip" required />

        <label for="throw-type">Throw Type</label>
        <select name="throw_type" id="throw-type" required>
          <option value="">Select throw type...</option>
          <option value="left">Left click</option>
          <option value="right">Right click</option>
          <option value="left_jump">Jump throw</option>
          <option value="run_left">Running throw</option>
        </select>

        <label>Position Screenshot</label>
        <input type="file" name="position" accept="image/*" />

        <label>Aim Screenshot</label>
        <input type="file" name="aim" accept="image/*" />

        <label>Result Screenshot</label>
        <input type="file" name="result" accept="image/*" />
      </div>

      <button type="submit" class="submit-btn" id="submit-btn">Submit Lineup</button>
      <p class="submit-status" id="submit-status"></p>
    </form>
  </div>
</Layout>

<script>
  const urlBtn = document.getElementById('mode-url-btn')!;
  const ssBtn = document.getElementById('mode-ss-btn')!;
  const urlSection = document.getElementById('url-section')!;
  const ssSection = document.getElementById('ss-section')!;
  const form = document.getElementById('submit-form') as HTMLFormElement;
  const status = document.getElementById('submit-status')!;

  const ssRequiredFields = ssSection.querySelectorAll('[required]');

  function setMode(mode: 'url' | 'screenshots') {
    const isUrl = mode === 'url';
    urlBtn.classList.toggle('active', isUrl);
    ssBtn.classList.toggle('active', !isUrl);
    urlSection.classList.toggle('hidden', !isUrl);
    ssSection.classList.toggle('hidden', isUrl);
    // Toggle required on screenshot fields so hidden inputs don't block submission
    ssRequiredFields.forEach(el => {
      if (isUrl) el.removeAttribute('required');
      else el.setAttribute('required', '');
    });
  }

  urlBtn.addEventListener('click', () => setMode('url'));
  ssBtn.addEventListener('click', () => setMode('screenshots'));

  // Initial state: URL mode is active, so strip required from hidden screenshot fields
  setMode('url');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    status.textContent = 'Submitting...';
    status.className = 'submit-status';

    const formData = new FormData(form);
    // Remove empty fields from the inactive mode
    if (urlBtn.classList.contains('active')) {
      formData.delete('position');
      formData.delete('aim');
      formData.delete('result');
      formData.delete('map');
      formData.delete('side');
      formData.delete('lineup_name');
      formData.delete('stand_desc');
      formData.delete('aim_desc');
      formData.delete('throw_type');

      // Validate csnades.gg URL
      const url = formData.get('csnades_url') as string;
      if (!url || !url.startsWith('https://csnades.gg/')) {
        status.textContent = 'URL must be a valid csnades.gg link (https://csnades.gg/...)';
        status.classList.add('error');
        return;
      }
    } else {
      formData.delete('csnades_url');
    }

    try {
      const base = (window as any).__base || '/';
      const res = await fetch(`${base}api/submissions`, { method: 'POST', body: formData });
      const data = await res.json();
      if (res.ok) {
        status.textContent = 'Submitted! Thanks for contributing.';
        status.classList.add('success');
        form.reset();
      } else {
        status.textContent = data.error || 'Submission failed';
        status.classList.add('error');
      }
    } catch {
      status.textContent = 'Network error, please try again';
      status.classList.add('error');
    }
  });
</script>
